import akshare as ak
import google.generativeai as genai
from tavily import TavilyClient
import sys
import os

# --------------------------  ç›´æ¥å¤ç”¨ä½ å·²æœ‰çš„é…ç½®ï¼Œä¸ç”¨æ”¹ä»»ä½•å†…å®¹  --------------------------
# 1. åˆå§‹åŒ–Gemini AI
genai.configure(api_key=os.getenv("GEMINI_API_KEY"))
ai_model = genai.GenerativeModel("gemini-1.5-flash")

# 2. åˆå§‹åŒ–Tavilyå®æ—¶æœç´¢
tavily = TavilyClient(api_key=os.getenv("TAVILY_API_KEY"))

# 3. æ¥æ”¶ä½ è¾“å…¥çš„è‚¡ç¥¨ä»£ç 
stock_code = sys.argv[1]
# ---------------------------------------------------------------------------------------------

try:
    # --------------------------  ç¬¬ä¸€æ­¥ï¼šè·å–è‚¡ç¥¨åŸºç¡€è¡Œæƒ…+åŸºæœ¬é¢æ•°æ®  --------------------------
    print("æ­£åœ¨è·å–è‚¡ç¥¨è¡Œæƒ…æ•°æ®...")
    # å®æ—¶è¡Œæƒ…æ•°æ®
    spot_data = ak.stock_zh_a_spot_em()
    code = stock_code.split(".")[0]
    stock_info = spot_data[spot_data["ä»£ç "] == code].iloc[0]
    stock_name = stock_info['åç§°']

    # æ•´ç†æ ¸å¿ƒæ•°æ®
    core_data = f"""
ã€{stock_name}ï¼ˆ{stock_code}ï¼‰ä»Šæ—¥æ ¸å¿ƒè¡Œæƒ…ã€‘
æœ€æ–°ä»·æ ¼ï¼š{stock_info['æœ€æ–°ä»·']} å…ƒ
ä»Šæ—¥æ¶¨è·Œå¹…ï¼š{stock_info['æ¶¨è·Œå¹…']} %
å¼€ç›˜ä»·ï¼š{stock_info['å¼€ç›˜']} å…ƒ
æœ€é«˜ä»·ï¼š{stock_info['æœ€é«˜']} å…ƒ
æœ€ä½ä»·ï¼š{stock_info['æœ€ä½']} å…ƒ
æˆäº¤é‡ï¼š{round(stock_info['æˆäº¤é‡']/10000, 2)} ä¸‡æ‰‹
æˆäº¤é¢ï¼š{round(stock_info['æˆäº¤é¢']/100000000, 2)} äº¿å…ƒ
æ¢æ‰‹ç‡ï¼š{stock_info['æ¢æ‰‹ç‡']} %
åŠ¨æ€å¸‚ç›ˆç‡ï¼š{stock_info['å¸‚ç›ˆç‡-åŠ¨æ€']}
å¸‚å‡€ç‡ï¼š{stock_info['å¸‚å‡€ç‡']}
ä»Šæ—¥æ¶¨é€Ÿï¼š{stock_info['æ¶¨é€Ÿ']} %
5åˆ†é’Ÿæ¶¨è·Œï¼š{stock_info['5åˆ†é’Ÿæ¶¨è·Œ']} %
å¹´åˆè‡³ä»Šæ¶¨è·Œå¹…ï¼š{stock_info['å¹´åˆè‡³ä»Šæ¶¨è·Œå¹…']} %
"""
    # ---------------------------------------------------------------------------------------------

    # --------------------------  ç¬¬äºŒæ­¥ï¼šç”¨Tavilyæœç´¢å®æ—¶ç›¸å…³ä¿¡æ¯ï¼ˆæ ¸å¿ƒå‡çº§ç‚¹ï¼‰  --------------------------
    print(f"æ­£åœ¨æœç´¢{stock_name}æœ€æ–°ç›¸å…³ä¿¡æ¯...")
    # æœç´¢å…³é”®è¯ï¼šè‚¡ç¥¨åç§°+æœ€æ–°å…¬å‘Š+æ–°é—»+è¡Œä¸šæ”¿ç­–
    search_result = tavily.search(
        query=f"Aè‚¡{stock_name} {code} æœ€æ–°å…¬å‘Š æ–°é—» è¡Œä¸šæ”¿ç­– å¸‚åœºæ¶ˆæ¯ 2025å¹´",
        search_depth="basic",
        max_results=3,
        include_answer=True
    )

    # æ•´ç†æœç´¢åˆ°çš„å®æ—¶ä¿¡æ¯
    news_content = ""
    if search_result.get("results"):
        news_content = "ã€æœ€æ–°ç›¸å…³åŠ¨æ€ã€‘\n"
        for idx, item in enumerate(search_result["results"][:3]):
            news_content += f"{idx+1}. {item['title']}\næ‘˜è¦ï¼š{item['content'][:100]}...\n"
    else:
        news_content = "ã€æœ€æ–°ç›¸å…³åŠ¨æ€ã€‘æš‚æ— æœ€æ–°é‡å¤§å…¬å‘Šæˆ–æ–°é—»\n"
    # ---------------------------------------------------------------------------------------------

    # --------------------------  ç¬¬ä¸‰æ­¥ï¼šç”¨Geminiç”Ÿæˆä¸“ä¸šæ·±åº¦åˆ†æ  --------------------------
    print("æ­£åœ¨ç”Ÿæˆæ·±åº¦åˆ†ææŠ¥å‘Š...")
    # ç»™AIçš„æç¤ºè¯ï¼Œä¸“ä¸šã€ç¨³å¥ã€é€‚åˆæ™®é€šæŠ•èµ„è€…
    prompt = f"""
ä½ æ˜¯ä¸€åæ‹¥æœ‰10å¹´ç»éªŒçš„Aè‚¡ä¸“ä¸šæŠ•èµ„é¡¾é—®ï¼ŒåŸºäºä¸‹é¢çš„è‚¡ç¥¨è¡Œæƒ…æ•°æ®å’Œæœ€æ–°åŠ¨æ€ä¿¡æ¯ï¼Œç”Ÿæˆä¸€ä»½400å­—ä»¥å†…çš„ä¸“ä¸šæ·±åº¦åˆ†ææŠ¥å‘Šï¼Œä¸¥æ ¼éµå®ˆä»¥ä¸‹è¦æ±‚ï¼š
1.  å¼€å¤´å…ˆç»™ä¸€ä¸ªæ˜ç¡®çš„ä»Šæ—¥è¡¨ç°æ€»ç»“ï¼Œç›´æ¥è¯´æ¶¨è·Œæ ¸å¿ƒåŸå› 
2.  åˆ†3ä¸ªæ¨¡å—ï¼šç›˜é¢è§£è¯»ã€æ¶ˆæ¯é¢å½±å“ã€æ“ä½œå»ºè®®ï¼Œæ¯ä¸ªæ¨¡å—ç”¨å°æ ‡é¢˜åŒºåˆ†
3.  ç›˜é¢è§£è¯»ç»“åˆè¡Œæƒ…æ•°æ®ï¼Œæ¶ˆæ¯é¢ç»“åˆæœç´¢åˆ°çš„æœ€æ–°åŠ¨æ€ï¼Œä¸è¦æ³›æ³›è€Œè°ˆ
4.  æ“ä½œå»ºè®®å¿…é¡»ä¿å®ˆç¨³å¥ï¼Œåˆ†æŒä»“å’Œç©ºä»“ä¸¤ç§æƒ…å†µç»™å‡ºï¼Œä¸è¦ç»™æ¿€è¿›çš„ä¹°å–å»ºè®®
5.  ç»“å°¾å¿…é¡»åŠ é€šç”¨çš„è‚¡å¸‚é£é™©æç¤º
6.  è¯­è¨€å£è¯­åŒ–ï¼Œé€šä¿—æ˜“æ‡‚ï¼Œé€‚åˆæ™®é€šæ•£æˆ·æŠ•èµ„è€…ï¼Œä¸è¦ç”¨å¤ªæ™¦æ¶©çš„ä¸“ä¸šæœ¯è¯­

ã€åŸºç¡€è¡Œæƒ…æ•°æ®ã€‘
{core_data}

ã€æœ€æ–°ç›¸å…³åŠ¨æ€ã€‘
{news_content}
    """

    # ç”Ÿæˆæœ€ç»ˆåˆ†ææŠ¥å‘Š
    ai_response = ai_model.generate_content(prompt)
    final_report = f"ğŸ“ˆ {stock_name} æ·±åº¦åˆ†ææŠ¥å‘Š\n\n{ai_response.text}\n\n{core_data}\n{news_content}"

except Exception as e:
    # å¼‚å¸¸å¤„ç†ï¼Œå“ªæ€•æŸä¸€æ­¥å¤±è´¥ï¼Œä¹Ÿä¸ä¼šå®Œå…¨æŠ¥é”™
    final_report = f"âŒ æ·±åº¦åˆ†æå¤±è´¥\nè‚¡ç¥¨ä»£ç ï¼š{stock_code}\né”™è¯¯åŸå› ï¼š{str(e)}\n\næ’æŸ¥å»ºè®®ï¼š\n1. æ£€æŸ¥è‚¡ç¥¨ä»£ç æ ¼å¼æ˜¯å¦æ­£ç¡®ï¼ˆæ²ªå¸‚åŠ .SH æ·±å¸‚åŠ .SZï¼‰\n2. æ ¸å¯¹Geminiã€Tavilyå¯†é’¥æ˜¯å¦é…ç½®æ­£ç¡®\n3. ç¡®è®¤APIé¢åº¦æ˜¯å¦å……è¶³"

# ä¿å­˜æŠ¥å‘Šï¼Œä¾›é’‰é’‰æ¨é€
with open("result.txt", "w", encoding="utf-8") as f:
    f.write(final_report)

print(final_report)
