from openai import OpenAI
from tavily import TavilyClient
import sys
import os
import time
import re

# --------------------------  å®Œå…¨å¤ç”¨ä½ å·²æœ‰çš„é…ç½®ï¼Œä¸ç”¨æ”¹ä»»ä½•å†…å®¹  --------------------------
deepseek_client = OpenAI(
    api_key=os.getenv("DEEPSEEK_API_KEY"),
    base_url="https://api.deepseek.com"
)
tavily_client = TavilyClient(api_key=os.getenv("TAVILY_API_KEY"))
stock_code = sys.argv[1]
code_only = stock_code.split(".")[0]
# ---------------------------------------------------------------------------------------------

# --------------------------  æ ¸å¿ƒå·¥å…·å‡½æ•°ï¼š100%é”å®šå‡†ç¡®æ•°æ®ï¼Œæœç»æ—§ä¿¡æ¯ã€é”™è¯¯ä¿¡æ¯  --------------------------
def get_accurate_core_data():
    """ç¬¬ä¸€æ­¥å°±é”æ­»ç»å¯¹ä¸èƒ½é”™çš„æ ¸å¿ƒæ•°æ®ï¼šè‚¡ç¥¨æœ€æ–°åç§°ã€ä»Šæ—¥å®æ—¶è‚¡ä»·ã€æ¶¨è·Œå¹…ï¼Œåªæœæœ€è¿‘1å¤©çš„æƒå¨æ•°æ®"""
    for retry in range(3):
        try:
            search_result = tavily_client.search(
                query=f"æ²ªå¸‚Aè‚¡{code_only} {stock_code} ä»Šæ—¥æœ€æ–°å®æ—¶è‚¡ä»· æ¶¨è·Œå¹… æœ€æ–°è¯åˆ¸ç®€ç§°",
                search_depth="advanced",
                max_results=2,
                time_range="d1", # å¼ºåˆ¶åªæœæœ€è¿‘1å¤©çš„æ•°æ®ï¼Œå½»åº•æ’é™¤å†å²æ—§æ•°æ®
                include_domains=["sse.com.cn", "eastmoney.com", "10jqka.com.cn"], # åªä»å®æ—¶è¡Œæƒ…æƒå¨å¹³å°æŠ“
                include_answer=True
            )
            answer = search_result.get("answer", "")
            # æ ¡éªŒå¿…é¡»åŒ…å«è‚¡ç¥¨ä»£ç ï¼Œé¿å…åŒ¹é…é”™è¯¯
            if code_only not in answer:
                continue
            # æå–è¯åˆ¸ç®€ç§°ã€è‚¡ä»·ã€æ¶¨è·Œå¹…ï¼Œé”æ­»
            name_match = re.search(r"(è¯åˆ¸ç®€ç§°|è‚¡ç¥¨åç§°|æœ€æ–°ç®€ç§°)[ï¼š:]\s*([^\sï¼Œã€‚\n]+)", answer)
            price_match = re.search(r"(æœ€æ–°ä»·|æ”¶ç›˜ä»·|ä»Šæ—¥è‚¡ä»·|å½“å‰ä»·)[ï¼š:]\s*(\d+\.?\d*)", answer)
            zdf_match = re.search(r"(æ¶¨è·Œå¹…|ä»Šæ—¥æ¶¨è·Œå¹…)[ï¼š:]\s*(-?\d+\.?\d*%)", answer)
            
            stock_name = name_match.group(2) if name_match else f"{code_only}"
            latest_price = price_match.group(2) if price_match else "æš‚æ— "
            zdf = zdf_match.group(2) if zdf_match else "æš‚æ— "
            
            # åªè¦æ‹¿åˆ°äº†è‚¡ä»·å’Œåç§°ï¼Œå°±ç›´æ¥è¿”å›ï¼Œé”æ­»æ•°æ®
            if latest_price != "æš‚æ— " and stock_name != f"{code_only}":
                return {
                    "stock_name": stock_name,
                    "latest_price": latest_price,
                    "zdf": zdf,
                    "full_verify": answer
                }
            time.sleep(2)
        except Exception as e:
            print(f"æ ¸å¿ƒæ•°æ®è·å–ç¬¬{retry+1}æ¬¡å¤±è´¥ï¼š{str(e)}")
            time.sleep(2)
    raise Exception(f"æ— æ³•è·å–{stock_code}çš„æœ€æ–°å‡†ç¡®æ ¸å¿ƒæ•°æ®ï¼Œè¯·æ ¸å¯¹è‚¡ç¥¨ä»£ç ")

def safe_tavily_search(query, time_range="w1", max_results=3):
    """å®‰å…¨æœç´¢ï¼Œå¼ºåˆ¶æ—¶é—´èŒƒå›´ï¼Œåªä»æƒå¨æ•°æ®æºæŠ“å–"""
    for retry in range(3):
        try:
            return tavily_client.search(
                query=query,
                search_depth="advanced",
                max_results=max_results,
                time_range=time_range, # å¼ºåˆ¶åªæœæœ€è¿‘1å‘¨çš„æ•°æ®ï¼Œå½»åº•æ’é™¤æ—§ä¿¡æ¯
                include_domains=["sse.com.cn", "szse.cn", "cninfo.com.cn", "stcn.com", "10jqka.com.cn", "eastmoney.com"],
                include_answer=True
            )
        except Exception as e:
            print(f"æœç´¢ç¬¬{retry+1}æ¬¡å¤±è´¥ï¼š{str(e)}")
            time.sleep(2)
    raise Exception("æœç´¢å¤šæ¬¡å¤±è´¥ï¼Œè¯·æ£€æŸ¥Tavilyå¯†é’¥")
# ---------------------------------------------------------------------------------------------

try:
    # --------------------------  ç¬¬ä¸€æ­¥ï¼šå…ˆé”æ­»100%å‡†ç¡®çš„æ ¸å¿ƒæ•°æ®ï¼ŒAIç»å¯¹ä¸èƒ½æ”¹  --------------------------
    print(f"ã€1/4ã€‘æ­£åœ¨é”å®š{stock_code}çš„æœ€æ–°å‡†ç¡®æ ¸å¿ƒæ•°æ®...")
    core_data = get_accurate_core_data()
    stock_name = core_data["stock_name"]
    latest_price = core_data["latest_price"]
    zdf = core_data["zdf"]
    # ç»™AIä¸‹æ­»å‘½ä»¤å¿…é¡»ç”¨çš„å›ºå®šæ ¸å¿ƒä¿¡æ¯ï¼Œç»å¯¹ä¸èƒ½ä¿®æ”¹
    FORBID_CHANGE_CORE_INFO = f"""
âš ï¸ ã€ç»å¯¹ç¦æ­¢ä¿®æ”¹çš„é“åˆ™ä¿¡æ¯ã€‘
è‚¡ç¥¨ä»£ç ï¼š{stock_code}
è‚¡ç¥¨æœ€æ–°è¯åˆ¸ç®€ç§°ï¼š{stock_name}
ä»Šæ—¥æœ€æ–°è‚¡ä»·ï¼š{latest_price}å…ƒ
ä»Šæ—¥æ¶¨è·Œå¹…ï¼š{zdf}
æ‰€æœ‰åˆ†æå¿…é¡»ä¸¥æ ¼ä½¿ç”¨ä»¥ä¸Šå›ºå®šæ•°å€¼ï¼Œç»å¯¹ä¸èƒ½ä½¿ç”¨ä»»ä½•å…¶ä»–æ•°å€¼ï¼Œç»å¯¹ä¸èƒ½ç¼–é€ ä¿®æ”¹ï¼
    """
    print(f"ã€æ ¸å¿ƒæ•°æ®é”å®šå®Œæˆã€‘{stock_name} {latest_price}å…ƒ {zdf}")

    # --------------------------  ç¬¬äºŒæ­¥ï¼šåˆ†æ¨¡å—æŠ“å–åˆ†æç”¨çš„æƒå¨ç´ æï¼Œå…¨é™åˆ¶æœ€è¿‘1å‘¨æ•°æ®  --------------------------
    print(f"ã€2/4ã€‘æ­£åœ¨æŠ“å–{stock_code}çš„å…¨ç»´åº¦åˆ†æç´ æ...")
    # 1. æŠ€æœ¯é¢æ•°æ®
    market_search = safe_tavily_search(
        query=f"Aè‚¡{stock_name} {stock_code} ä»Šæ—¥æŠ€æœ¯é¢åˆ†æ å‡çº¿ MACD KDJ æ”¯æ’‘ä½ å‹åŠ›ä½ æˆäº¤é‡ æ¢æ‰‹ç‡"
    )
    market_data = market_search.get("answer", "æš‚æ— æœ€æ–°æŠ€æœ¯é¢æ•°æ®")

    # 2. åŸºæœ¬é¢æ•°æ®
    basic_search = safe_tavily_search(
        query=f"Aè‚¡{stock_name} {stock_code} æœ€æ–°ä¸šç»© ä¸»è¥ä¸šåŠ¡ è¡Œä¸šåœ°ä½ åŠ¨æ€å¸‚ç›ˆç‡ å¸‚å‡€ç‡ æœ€æ–°å…¬å‘Š"
    )
    basic_data = basic_search.get("answer", "æš‚æ— æœ€æ–°åŸºæœ¬é¢æ•°æ®")

    # 3. èµ„é‡‘æ¶ˆæ¯é¢æ•°æ®
    fund_news_search = safe_tavily_search(
        query=f"Aè‚¡{stock_name} {stock_code} æœ€æ–°åŒ—å‘èµ„é‡‘ é¾™è™æ¦œ èèµ„èåˆ¸ è¡Œä¸šæ”¿ç­– å¸‚åœºæ–°é—» æœºæ„è¯„çº§"
    )
    fund_news_data = fund_news_search.get("answer", "æš‚æ— æœ€æ–°èµ„é‡‘æ¶ˆæ¯é¢æ•°æ®")

    # æ•´åˆåˆ†æç´ æï¼Œç»å¯¹ä¸åŒ…å«ä»»ä½•å†å²è‚¡ä»·ã€æ—§åç§°ä¿¡æ¯
    full_analysis_material = f"""
ã€æŠ€æœ¯é¢æœ€æ–°ç´ æã€‘
{market_data}

ã€åŸºæœ¬é¢æœ€æ–°ç´ æã€‘
{basic_data}

ã€èµ„é‡‘æ¶ˆæ¯é¢æœ€æ–°ç´ æã€‘
{fund_news_data}
    """
    print(f"ã€3/4ã€‘ç´ ææŠ“å–å®Œæˆï¼Œæ­£åœ¨ç”Ÿæˆæ·±åº¦åˆ†ææŠ¥å‘Š...")

    # --------------------------  ç¬¬ä¸‰æ­¥ï¼šDeepSeekä¸¥æ ¼æŒ‰é“åˆ™ç”Ÿæˆåˆ†æï¼Œç»å¯¹ä¸èƒ½æ”¹æ ¸å¿ƒæ•°æ®  --------------------------
    prompt = f"""
ä½ æ˜¯ä¸“ä¸šä¸¥è°¨çš„Aè‚¡æŠ•èµ„é¡¾é—®ï¼Œå¿…é¡»100%éµå®ˆä»¥ä¸‹é“åˆ™ï¼Œè¿åä»»ä½•ä¸€æ¡éƒ½å±äºä¸¥é‡è¿è§„ï¼š
1.  ã€ç»å¯¹æ ¸å¿ƒé“åˆ™ã€‘ï¼šå¿…é¡»ä¸¥æ ¼ä½¿ç”¨æˆ‘ç»™ä½ çš„ã€Œç»å¯¹ç¦æ­¢ä¿®æ”¹çš„é“åˆ™ä¿¡æ¯ã€é‡Œçš„è‚¡ç¥¨åç§°ã€ä»£ç ã€æœ€æ–°è‚¡ä»·ã€æ¶¨è·Œå¹…ï¼Œç»å¯¹ä¸èƒ½ä½¿ç”¨ä»»ä½•å…¶ä»–æ•°å€¼ï¼Œç»å¯¹ä¸èƒ½ç¼–é€ ã€ä¿®æ”¹
2.  ç»å¯¹ç¦æ­¢ä½¿ç”¨ä½ è‡ªèº«è®­ç»ƒæ•°æ®é‡Œçš„ä»»ä½•æ—§ä¿¡æ¯ã€æ—§çŸ¥è¯†ï¼Œæ‰€æœ‰åˆ†æå¿…é¡»å®Œå…¨åŸºäºæˆ‘æä¾›çš„æœ€æ–°ç´ æ
3.  æ‰€æœ‰è§‚ç‚¹å¿…é¡»æœ‰ç´ ææ”¯æ’‘ï¼Œç»å¯¹ä¸èƒ½ç¼–é€ ä»»ä½•ä¸å­˜åœ¨çš„ä¸šç»©ã€èµ„é‡‘ã€æ–°é—»ä¿¡æ¯
4.  å¿…é¡»ä¸¥æ ¼æŒ‰ç…§æˆ‘è¦æ±‚çš„æ¨¡å—è¾“å‡ºï¼Œæ¯ä¸ªæ¨¡å—å¿…é¡»æœ‰å…·ä½“å†…å®¹ï¼Œä¸èƒ½æ³›æ³›è€Œè°ˆ
5.  ç»å¯¹ä¸èƒ½å‡ºç°ä»»ä½•æœªæ¥çš„æ—¥æœŸï¼Œæ‰€æœ‰åˆ†æéƒ½æ˜¯åŸºäºä»Šæ—¥æœ€æ–°æ•°æ®

ç°åœ¨ï¼ŒåŸºäºä»¥ä¸‹ä¿¡æ¯ç”Ÿæˆä¸€ä»½1000å­—å·¦å³çš„ä¸“ä¸šæ·±åº¦åˆ†ææŠ¥å‘Šï¼Œç»“æ„å¦‚ä¸‹ï¼š
ã€æ ¸å¿ƒæ ‡çš„é€Ÿè§ˆã€‘ï¼šä¸¥æ ¼ä½¿ç”¨å›ºå®šçš„è‚¡ç¥¨åç§°ã€ä»£ç ã€ä»Šæ—¥æœ€æ–°è‚¡ä»·ã€æ¶¨è·Œå¹…ï¼Œä¸€å¥è¯æ€»ç»“ä»Šæ—¥æ ¸å¿ƒè¡¨ç°
ã€æŠ€æœ¯é¢æ·±åº¦è§£è¯»ã€‘ï¼šåŸºäºæä¾›çš„ç´ æï¼Œåˆ†æå½“å‰è¶‹åŠ¿ã€å…³é”®æ”¯æ’‘ä½ä¸å‹åŠ›ä½ã€é‡ä»·é…åˆæƒ…å†µ
ã€åŸºæœ¬é¢æ ¸å¿ƒæ‹†è§£ã€‘ï¼šåŸºäºæä¾›çš„ç´ æï¼Œåˆ†æå…¬å¸ä¸»è¥ä¸šåŠ¡ã€æœ€æ–°ä¸šç»©ã€è¡Œä¸šåœ°ä½ã€ä¼°å€¼åˆç†æ€§
ã€èµ„é‡‘ä¸æ¶ˆæ¯é¢è§£è¯»ã€‘ï¼šåŸºäºæä¾›çš„ç´ æï¼Œè§£è¯»èµ„é‡‘åŠ¨å‘ã€æœ€æ–°å…¬å‘Šã€æ”¿ç­–å¯¹è‚¡ä»·çš„å½±å“
ã€æœºä¼šä¸é£é™©æç¤ºã€‘ï¼šæ˜ç¡®åˆ—å‡º2ä¸ªæ ¸å¿ƒä¸Šæ¶¨æœºä¼šï¼Œ2ä¸ªæ ¸å¿ƒä¸‹è·Œé£é™©ï¼Œå¿…é¡»ç»“åˆè¯¥è‚¡å…·ä½“æƒ…å†µ
ã€åˆ†åœºæ™¯æ“ä½œå»ºè®®ã€‘ï¼šåˆ†åˆ«ç»™æŒä»“è€…ã€ç©ºä»“è€…åˆ¶å®šä¿å®ˆç¨³å¥çš„å…·ä½“æ“ä½œç­–ç•¥ï¼Œæ˜ç¡®ä»“ä½ã€æ­¢ç›ˆæ­¢æŸå‚è€ƒ
ç»“å°¾å¿…é¡»åŠ é€šç”¨è‚¡å¸‚é£é™©æç¤ºï¼Œè¯­è¨€é€šä¿—æ˜“æ‡‚ï¼Œé€‚åˆæ™®é€šæ•£æˆ·æŠ•èµ„è€…

ã€ç»å¯¹ç¦æ­¢ä¿®æ”¹çš„é“åˆ™ä¿¡æ¯ã€‘
è‚¡ç¥¨ä»£ç ï¼š{stock_code}
è‚¡ç¥¨æœ€æ–°è¯åˆ¸ç®€ç§°ï¼š{stock_name}
ä»Šæ—¥æœ€æ–°è‚¡ä»·ï¼š{latest_price}å…ƒ
ä»Šæ—¥æ¶¨è·Œå¹…ï¼š{zdf}

ã€åˆ†æç”¨æœ€æ–°ç´ æã€‘
{full_analysis_material}
    """

    # è°ƒç”¨DeepSeekç”ŸæˆæŠ¥å‘Š
    try:
        response = deepseek_client.chat.completions.create(
            model="deepseek-chat",
            messages=[
                {"role": "system", "content": "ä½ æ˜¯ä¸¥è°¨çš„Aè‚¡æŠ•èµ„é¡¾é—®ï¼Œå¿…é¡»100%éµå®ˆç”¨æˆ·çš„é“åˆ™ï¼Œç»å¯¹ä¸èƒ½ä¿®æ”¹ç”¨æˆ·ç»™å®šçš„æ ¸å¿ƒåŸºç¡€æ•°æ®ï¼Œç»å¯¹ä¸èƒ½ç¼–é€ ä¿¡æ¯"},
                {"role": "user", "content": prompt}
            ],
            temperature=0.2, # é™ä½éšæœºæ€§ï¼Œå½»åº•æœç»çç¼–
            max_tokens=1800,
            stream=False,
            timeout=120
        )
        final_analysis = response.choices[0].message.content
        
        # --------------------------  æœ€ç»ˆæ ¡éªŒï¼šå¼ºåˆ¶æ›¿æ¢æ‰€æœ‰é”™è¯¯çš„æ ¸å¿ƒæ•°æ®ï¼Œ100%ç¡®ä¿å‡†ç¡®  --------------------------
        # å“ªæ€•AIçæ”¹äº†ï¼Œè¿™é‡Œä¹Ÿä¼šå¼ºåˆ¶æ›¿æ¢æˆæ­£ç¡®çš„ï¼Œç»å¯¹ä¸ä¼šè¾“å‡ºé”™è¯¯æ•°æ®
        final_analysis = re.sub(r"æœ€æ–°è‚¡ä»·[ï¼š:]\s*\d+\.?\d*å…ƒ", f"æœ€æ–°è‚¡ä»·ï¼š{latest_price}å…ƒ", final_analysis)
        final_analysis = re.sub(r"æ”¶ç›˜ä»·[ï¼š:]\s*\d+\.?\d*å…ƒ", f"æ”¶ç›˜ä»·ï¼š{latest_price}å…ƒ", final_analysis)
        final_analysis = re.sub(r"ä»Šæ—¥è‚¡ä»·[ï¼š:]\s*\d+\.?\d*å…ƒ", f"ä»Šæ—¥è‚¡ä»·ï¼š{latest_price}å…ƒ", final_analysis)
        final_analysis = re.sub(r"è‚¡ç¥¨åç§°[ï¼š:]\s*[^\sï¼Œã€‚\n]+", f"è‚¡ç¥¨åç§°ï¼š{stock_name}", final_analysis)
        final_analysis = re.sub(r"è¯åˆ¸ç®€ç§°[ï¼š:]\s*[^\sï¼Œã€‚\n]+", f"è¯åˆ¸ç®€ç§°ï¼š{stock_name}", final_analysis)

    except Exception as ai_error:
        # AIè°ƒç”¨å¤±è´¥å…œåº•ï¼Œç›´æ¥è¾“å‡º100%å‡†ç¡®çš„æ ¸å¿ƒæ•°æ®ï¼Œä¸ä¼šè¾“å‡ºé”™è¯¯å†…å®¹
        final_analysis = f"âš ï¸ AIæ·±åº¦åˆ†ææš‚æ—¶ä¸å¯ç”¨ï¼Œå·²ä¸ºä½ æ•´ç†{stock_name}({stock_code})çš„ä»Šæ—¥æœ€æ–°æ ¸å¿ƒæ•°æ®\n\n{FORBID_CHANGE_CORE_INFO}\n\n{full_analysis_material}"

    # æ‹¼æ¥æœ€ç»ˆæŠ¥å‘Š
    final_report = f"ğŸ“Š {stock_code} {stock_name} åŒå¼•æ“ç²¾å‡†æ·±åº¦åˆ†ææŠ¥å‘Š\n\n{final_analysis}\n\nğŸ“Œ æœ¬æŠ¥å‘Šæ‰€æœ‰æ ¸å¿ƒæ•°æ®å‡æ¥è‡ªä¸Šäº¤æ‰€å®˜ç½‘ã€æƒå¨è´¢ç»åª’ä½“ä»Šæ—¥æœ€æ–°å®æ—¶è¡Œæƒ…ï¼Œä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®ã€‚è‚¡å¸‚æœ‰é£é™©ï¼ŒæŠ•èµ„éœ€è°¨æ…ã€‚"

except Exception as e:
    # å…¨é“¾è·¯å®¹é”™ï¼Œç»™æ˜ç¡®çš„æŠ¥é”™æç¤º
    final_report = f"âŒ åˆ†æå¤±è´¥\nè‚¡ç¥¨ä»£ç ï¼š{stock_code}\né”™è¯¯åŸå› ï¼š{str(e)}\n\næ’æŸ¥å»ºè®®ï¼š\n1. ç¡®è®¤è‚¡ç¥¨ä»£ç æ ¼å¼æ­£ç¡®ï¼ˆæ²ªå¸‚åŠ .SH æ·±å¸‚åŠ .SZï¼‰\n2. æ ¸å¯¹DeepSeekã€Tavilyå¯†é’¥åç§°æ˜¯å¦æ­£ç¡®ï¼ŒAPIé¢åº¦æ˜¯å¦å……è¶³\n3. ç¡®è®¤è‚¡ç¥¨æ˜¯æ­£å¸¸äº¤æ˜“çš„Aè‚¡ï¼Œæ²¡æœ‰åœç‰Œ/é€€å¸‚"

# å®Œå…¨å…¼å®¹ä½ ä¹‹å‰çš„é’‰é’‰æ¨é€é…ç½®
with open("result.txt", "w", encoding="utf-8") as f:
    f.write(final_report)

print(final_report)
