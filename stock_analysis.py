from openai import OpenAI
from tavily import TavilyClient
import sys
import os
import time

# --------------------------  å®Œå…¨å¤ç”¨ä½ å·²æœ‰çš„é…ç½®ï¼Œä¸ç”¨æ”¹ä»»ä½•å†…å®¹  --------------------------
# åˆå§‹åŒ–DeepSeekï¼ˆå®˜æ–¹ç¨³å®šæ¨¡å¼ï¼Œä¸ä¼šæŠ¥æ¨¡å‹404ï¼‰
deepseek_client = OpenAI(
    api_key=os.getenv("DEEPSEEK_API_KEY"),
    base_url="https://api.deepseek.com"
)
# åˆå§‹åŒ–Tavilyï¼ˆç²¾å‡†ä¿¡æ¯æŠ“å–ï¼‰
tavily_client = TavilyClient(api_key=os.getenv("TAVILY_API_KEY"))
# æ¥æ”¶ä½ è¾“å…¥çš„è‚¡ç¥¨ä»£ç 
stock_code = sys.argv[1]
# ---------------------------------------------------------------------------------------------

# --------------------------  å·¥å…·å‡½æ•°ï¼šå¸¦é‡è¯•çš„ä¿¡æ¯æŠ“å–ï¼Œæå‡ç¨³å®šæ€§  --------------------------
def tavily_search_with_retry(query, max_retry=3, **kwargs):
    """å¸¦é‡è¯•çš„Tavilyæœç´¢ï¼Œé¿å…ä¸´æ—¶ç½‘ç»œæ³¢åŠ¨æŠ¥é”™"""
    for retry in range(max_retry):
        try:
            return tavily_client.search(query=query, **kwargs)
        except Exception as e:
            print(f"Tavilyæœç´¢ç¬¬{retry+1}æ¬¡å¤±è´¥ï¼š{str(e)}")
            time.sleep(2)
    raise Exception(f"Tavilyæœç´¢å¤šæ¬¡å¤±è´¥ï¼Œè¯·æ£€æŸ¥ç½‘ç»œå’ŒAPIå¯†é’¥")
# ---------------------------------------------------------------------------------------------

try:
    # --------------------------  ç¬¬ä¸€æ­¥ï¼šTavilyåˆ†æ¨¡å—ç²¾å‡†æŠ“å–å…¨ç»´åº¦æƒå¨æ•°æ®  --------------------------
    print(f"ã€1/3ã€‘æ­£åœ¨æŠ“å–{stock_code}å…¨ç»´åº¦æƒå¨æ•°æ®...")
    # 1. æ ¸å¿ƒè¡Œæƒ…+æŠ€æœ¯é¢æ•°æ®
    market_search = tavily_search_with_retry(
        query=f"Aè‚¡{stock_code} ä»Šæ—¥æœ€æ–°å®æ—¶è¡Œæƒ… è‚¡ä»· æ¶¨è·Œå¹… å¼€ç›˜ä»· æœ€é«˜ä»· æœ€ä½ä»· æˆäº¤é‡ æˆäº¤é¢ å‡çº¿ MACD KDJ æ”¯æ’‘ä½ å‹åŠ›ä½ æ¢æ‰‹ç‡",
        search_depth="advanced",
        max_results=3,
        include_domains=["sse.com.cn", "szse.cn", "eastmoney.com", "10jqka.com.cn"],
        include_answer=True
    )
    market_data = market_search.get("answer", "")

    # 2. åŸºæœ¬é¢+è¡Œä¸šæ•°æ®
    basic_search = tavily_search_with_retry(
        query=f"Aè‚¡{stock_code} æœ€æ–°ä¸šç»©æŠ¥å‘Š ä¸»è¥ä¸šåŠ¡ è¡Œä¸šåœ°ä½ åŠ¨æ€å¸‚ç›ˆç‡ å¸‚å‡€ç‡ è¡Œä¸šæ’å æ ¸å¿ƒç«äº‰åŠ› æœ€æ–°å…¬å‘Š",
        search_depth="advanced",
        max_results=3,
        include_domains=["sse.com.cn", "szse.cn", "cninfo.com.cn", "stcn.com"],
        include_answer=True
    )
    basic_data = basic_search.get("answer", "")

    # 3. èµ„é‡‘é¢+æ¶ˆæ¯é¢æ•°æ®
    fund_news_search = tavily_search_with_retry(
        query=f"Aè‚¡{stock_code} åŒ—å‘èµ„é‡‘åŠ¨å‘ é¾™è™æ¦œæ•°æ® èèµ„èåˆ¸ æœ€æ–°è¡Œä¸šæ”¿ç­– å¸‚åœºæ–°é—» æœºæ„è¯„çº§ åˆ¸å•†ç ”æŠ¥è§‚ç‚¹",
        search_depth="advanced",
        max_results=4,
        include_domains=["eastmoney.com", "10jqka.com.cn", "cnstock.com", "stcn.com"],
        include_answer=True
    )
    fund_news_data = fund_news_search.get("answer", "")

    # 4. æ•´åˆæ‰€æœ‰æŠ“å–åˆ°çš„åŸå§‹æ•°æ®ï¼Œå–‚ç»™DeepSeek
    full_raw_data = f"""
ã€ä¸€ã€æ ¸å¿ƒè¡Œæƒ…ä¸æŠ€æœ¯é¢æ•°æ®ã€‘
{market_data}

ã€äºŒã€åŸºæœ¬é¢ä¸è¡Œä¸šæ•°æ®ã€‘
{basic_data}

ã€ä¸‰ã€èµ„é‡‘é¢ä¸æ¶ˆæ¯é¢æ•°æ®ã€‘
{fund_news_data}
    """
    print(f"ã€2/3ã€‘æ•°æ®æŠ“å–å®Œæˆï¼Œæ­£åœ¨ç”Ÿæˆæ·±åº¦åˆ†ææŠ¥å‘Š...")
    # ---------------------------------------------------------------------------------------------

    # --------------------------  ç¬¬äºŒæ­¥ï¼šDeepSeekåŸºäºçœŸå®æ•°æ®åšå…¨ç»´åº¦æ·±åº¦åˆ†æ  --------------------------
    # ç²¾å‡†æç¤ºè¯ï¼Œå¼ºåˆ¶DeepSeekåªåŸºäºæä¾›çš„æ•°æ®åˆ†æï¼Œæœç»çç¼–ï¼ŒåŒæ—¶ä¿è¯æ·±åº¦å’Œç»“æ„
    prompt = f"""
ä½ æ˜¯æ‹¥æœ‰15å¹´Aè‚¡å®æˆ˜ç»éªŒçš„èµ„æ·±æŠ•èµ„é¡¾é—®ï¼Œç°åœ¨å¿…é¡»**å®Œå…¨åŸºäºæˆ‘æä¾›çš„çœŸå®è‚¡ç¥¨æ•°æ®**ï¼Œç”Ÿæˆä¸€ä»½1200å­—å·¦å³çš„ä¸“ä¸šæ·±åº¦æŠ•èµ„åˆ†ææŠ¥å‘Šï¼Œä¸¥æ ¼éµå®ˆä»¥ä¸‹æ‰€æœ‰è¦æ±‚ï¼š
1.  æŠ¥å‘Šå¿…é¡»åˆ†7ä¸ªå›ºå®šæ¨¡å—ï¼Œæ¯ä¸ªæ¨¡å—ç”¨ã€ã€‘æ ‡æ³¨å°æ ‡é¢˜ï¼Œç»“æ„æ¸…æ™°ï¼Œæ¯ä¸ªæ¨¡å—å¿…é¡»æœ‰å…·ä½“æ•°æ®æ”¯æ’‘ï¼Œç»å¯¹ä¸èƒ½æ³›æ³›è€Œè°ˆï¼Œç»å¯¹ä¸èƒ½ç¼–é€ æ•°æ®
2.  ã€æ ¸å¿ƒè¡Œæƒ…å¤ç›˜ã€‘ï¼šæ˜ç¡®è‚¡ç¥¨åç§°ã€ä»£ç ã€ä»Šæ—¥æ ¸å¿ƒè¡Œæƒ…è¡¨ç°ï¼Œå¯¹æ¯”å¤§ç›˜å’Œæ‰€å±æ¿å—çš„å¼ºå¼±ï¼Œåˆ†æä»Šæ—¥é‡ä»·é…åˆæƒ…å†µ
3.  ã€æŠ€æœ¯é¢æ·±åº¦è§£è¯»ã€‘ï¼šç»“åˆå‡çº¿ã€MACDã€KDJã€æ¢æ‰‹ç‡ç­‰æŒ‡æ ‡ï¼Œåˆ†æå½“å‰è¶‹åŠ¿ã€å…³é”®æ”¯æ’‘ä½ä¸å‹åŠ›ä½ï¼Œåˆ¤æ–­çŸ­æœŸèµ°åŠ¿æ¦‚ç‡
4.  åŸºæœ¬é¢æ ¸å¿ƒæ‹†è§£ã€‘ï¼šåˆ†æå…¬å¸ä¸»è¥ä¸šåŠ¡æ ¸å¿ƒäº®ç‚¹ã€æœ€æ–°ä¸šç»©è¡¨ç°ã€è¡Œä¸šå†…çš„ç«äº‰åœ°ä½ã€ä¼°å€¼æ°´å¹³åœ¨è¡Œä¸šå†…çš„åˆç†æ€§
5.  ã€èµ„é‡‘ä¸æ¶ˆæ¯é¢è§£è¯»ã€‘ï¼šè§£è¯»åŒ—å‘èµ„é‡‘ã€æœºæ„èµ„é‡‘çš„åŠ¨å‘ï¼Œæœ€æ–°å…¬å‘Šã€è¡Œä¸šæ”¿ç­–ã€å¸‚åœºæ–°é—»å¯¹è‚¡ä»·çš„å½±å“ï¼Œåˆ¸å•†ç ”æŠ¥çš„æ ¸å¿ƒè§‚ç‚¹
6.  ã€æœºä¼šä¸é£é™©æ·±åº¦åˆ†æã€‘ï¼šæ˜ç¡®åˆ—å‡º3ä¸ªæ ¸å¿ƒä¸Šæ¶¨é©±åŠ¨æœºä¼šï¼Œ3ä¸ªæ ¸å¿ƒä¸‹è·Œé£é™©ï¼Œå¿…é¡»ç»“åˆè¿™åªè‚¡ç¥¨çš„å…·ä½“æƒ…å†µï¼Œä¸èƒ½è¯´é€šç”¨ç©ºè¯
7.  ã€åˆ†åœºæ™¯å®æˆ˜æ“ä½œç­–ç•¥ã€‘ï¼šåˆ†åˆ«ç»™æŒä»“è€…ã€ç©ºä»“è€…åˆ¶å®šä¿å®ˆç¨³å¥çš„å…·ä½“æ“ä½œè®¡åˆ’ï¼Œæ˜ç¡®ä»“ä½å»ºè®®ã€æ­¢ç›ˆæ­¢æŸçš„å…·ä½“å‚è€ƒä½ç½®
8.  ç»“å°¾å¿…é¡»åŠ é€šç”¨çš„è‚¡å¸‚é£é™©æç¤ºï¼Œè¯­è¨€é€šä¿—æ˜“æ‡‚ï¼Œé€‚åˆæ™®é€šæ•£æˆ·æŠ•èµ„è€…ï¼Œä¸è¦ç”¨è¿‡äºæ™¦æ¶©çš„ä¸“ä¸šæœ¯è¯­
9.  æ‰€æœ‰åˆ†æå¿…é¡»å®Œå…¨åŸºäºæˆ‘æä¾›çš„çœŸå®æ•°æ®ï¼Œç»å¯¹ä¸èƒ½ç¼–é€ ä»»ä½•ä¸å­˜åœ¨çš„ä¿¡æ¯

æˆ‘æä¾›çš„è‚¡ç¥¨çœŸå®æ•°æ®ï¼š
{full_raw_data}
    """

    # è°ƒç”¨DeepSeekç”ŸæˆæŠ¥å‘Šï¼ŒåŠ å®¹é”™ï¼Œé¿å…ä¸´æ—¶æŠ¥é”™
    try:
        response = deepseek_client.chat.completions.create(
            model="deepseek-chat",
            messages=[
                {"role": "system", "content": "ä½ æ˜¯ä¸“ä¸šä¸¥è°¨çš„Aè‚¡èµ„æ·±æŠ•èµ„é¡¾é—®ï¼Œæ‰€æœ‰åˆ†æå¿…é¡»åŸºäºçœŸå®æ•°æ®ï¼Œç»å¯¹ä¸èƒ½ç¼–é€ ä¿¡æ¯"},
                {"role": "user", "content": prompt}
            ],
            temperature=0.4,
            max_tokens=2000,
            stream=False,
            timeout=120
        )
        final_analysis = response.choices[0].message.content
    except Exception as ai_error:
        # DeepSeekè°ƒç”¨å¤±è´¥å…œåº•ï¼Œç›´æ¥è¾“å‡ºTavilyæ•´ç†çš„æ ¸å¿ƒæ•°æ®ï¼Œä¸ä¼šå…¨æµç¨‹å´©
        final_analysis = f"âš ï¸ AIæ·±åº¦åˆ†ææš‚æ—¶ä¸å¯ç”¨ï¼Œå·²ä¸ºä½ æ•´ç†{stock_code}çš„å…¨ç»´åº¦æ ¸å¿ƒæ•°æ®\n\n{full_raw_data}"

    # æ‹¼æ¥æœ€ç»ˆæŠ¥å‘Šï¼Œå®Œå…¨å…¼å®¹é’‰é’‰æ¨é€
    final_report = f"ğŸ“Š {stock_code} åŒå¼•æ“å…¨ç»´åº¦æ·±åº¦åˆ†ææŠ¥å‘Š\n\n{final_analysis}\n\nğŸ“Œ æœ¬æŠ¥å‘Šæ•°æ®å‡æ¥è‡ªäº¤æ˜“æ‰€å®˜ç½‘ã€æƒå¨è´¢ç»åª’ä½“ï¼Œä»…ä¾›å‚è€ƒï¼Œä¸æ„æˆä»»ä½•æŠ•èµ„å»ºè®®ã€‚è‚¡å¸‚æœ‰é£é™©ï¼ŒæŠ•èµ„éœ€è°¨æ…ã€‚"

except Exception as e:
    # å…¨é“¾è·¯å®¹é”™ï¼Œç»™æ˜ç¡®çš„æŠ¥é”™æç¤ºï¼Œæ–¹ä¾¿ä½ æ’æŸ¥
    final_report = f"âŒ æ·±åº¦åˆ†æå¤±è´¥\nè‚¡ç¥¨ä»£ç ï¼š{stock_code}\né”™è¯¯åŸå› ï¼š{str(e)}\n\næ’æŸ¥å»ºè®®ï¼š\n1. ç¡®è®¤è‚¡ç¥¨ä»£ç æ ¼å¼æ­£ç¡®ï¼ˆæ²ªå¸‚åŠ .SH æ·±å¸‚åŠ .SZï¼‰\n2. æ ¸å¯¹DeepSeekã€Tavilyå¯†é’¥åç§°æ˜¯å¦æ­£ç¡®ï¼ŒAPIé¢åº¦æ˜¯å¦å……è¶³\n3. ç¡®è®¤è‚¡ç¥¨æ˜¯æ­£å¸¸äº¤æ˜“çš„Aè‚¡ï¼Œæ²¡æœ‰åœç‰Œ/é€€å¸‚"

# ä¿å­˜æŠ¥å‘Šï¼Œ100%å…¼å®¹ä½ ä¹‹å‰çš„é’‰é’‰æ¨é€é…ç½®ï¼Œä¸ç”¨æ”¹ä»»ä½•ä¸œè¥¿
with open("result.txt", "w", encoding="utf-8") as f:
    f.write(final_report)

print(final_report)
