import google.generativeai as genai
from tavily import TavilyClient
import sys
import os

# --------------------------  å®Œå…¨å¤ç”¨ä½ å·²æœ‰çš„é…ç½®ï¼Œä¸ç”¨æ”¹ä»»ä½•å†…å®¹  --------------------------
genai.configure(api_key=os.getenv("GEMINI_API_KEY"))
ai_model = genai.GenerativeModel("gemini-1.0-pro")
tavily = TavilyClient(api_key=os.getenv("TAVILY_API_KEY"))
stock_code = sys.argv[1]
# ---------------------------------------------------------------------------------------------

try:
    # --------------------------  ä¼˜åŒ–æœç´¢queryï¼Œå…¨ç»´åº¦ä¿¡æ¯æŠ“å–ï¼Œä¿¡æ¯æ‹‰æ»¡  --------------------------
    print(f"æ­£åœ¨è·å–{stock_code}çš„å…¨ç»´åº¦è¡Œæƒ…å’Œç›¸å…³ä¿¡æ¯...")
    search_result = tavily.search(
        query=f"Aè‚¡{stock_code} ä»Šæ—¥æœ€æ–°å®æ—¶è¡Œæƒ… è‚¡ä»· æ¶¨è·Œå¹… å¼€ç›˜ä»· æœ€é«˜ä»· æœ€ä½ä»· æˆäº¤é‡ æˆäº¤é¢ æœ€æ–°å…¬å‘Š é¾™è™æ¦œ åŒ—å‘èµ„é‡‘ åˆ¸å•†è¯„çº§ è¡Œä¸šæ–°é—» 2025å¹´",
        search_depth="advanced",
        max_results=6,
        include_answer=True,
        include_raw_content=False
    )

    # æå–å…¨éƒ¨æ ¸å¿ƒä¿¡æ¯
    search_answer = search_result.get("answer", "")
    search_details = ""
    for idx, item in enumerate(search_result.get("results", [])):
        search_details += f"\n{idx+1}. {item['title']}ï¼š{item['content'][:180]}"
    full_info = f"ã€æ ¸å¿ƒè¡Œæƒ…ä¸æ¶ˆæ¯æ‘˜è¦ã€‘{search_answer}\nã€è¯¦ç»†ä¿¡æ¯è¡¥å……ã€‘{search_details}"

    # ---------------------------------------------------------------------------------------------

    # --------------------------  ä¼˜åŒ–AIæç¤ºè¯ï¼Œè¾“å‡ºæ›´ä¸“ä¸šçš„æ·±åº¦åˆ†æ  --------------------------
    print("æ­£åœ¨ç”Ÿæˆå…¨ç»´åº¦æ·±åº¦åˆ†ææŠ¥å‘Š...")
    prompt = f"""
ä½ æ˜¯ä¸€åæ‹¥æœ‰10å¹´ç»éªŒçš„Aè‚¡ä¸“ä¸šæŠ•èµ„é¡¾é—®ï¼ŒåŸºäºä¸‹é¢çš„è‚¡ç¥¨å…¨ç»´åº¦ä¿¡æ¯ï¼Œç”Ÿæˆä¸€ä»½450å­—ä»¥å†…çš„ä¸“ä¸šæ·±åº¦åˆ†ææŠ¥å‘Šï¼Œä¸¥æ ¼éµå®ˆä»¥ä¸‹è¦æ±‚ï¼š
1.  å¼€å¤´å¿…é¡»æ˜ç¡®ï¼šè‚¡ç¥¨åç§°ã€è‚¡ç¥¨ä»£ç ã€ä»Šæ—¥æœ€æ–°è‚¡ä»·ã€ä»Šæ—¥æ¶¨è·Œå¹…
2.  åˆ†4ä¸ªæ¸…æ™°æ¨¡å—ï¼šç›˜é¢è§£è¯»ã€æ¶ˆæ¯é¢å½±å“ã€èµ„é‡‘é¢åŠ¨å‘ã€æ“ä½œå»ºè®®ï¼Œæ¯ä¸ªæ¨¡å—ç”¨å°æ ‡é¢˜åŒºåˆ†
3.  æ¯ä¸ªæ¨¡å—éƒ½è¦ç»“åˆæœç´¢åˆ°çš„å…·ä½“ä¿¡æ¯ï¼Œä¸è¦æ³›æ³›è€Œè°ˆï¼Œä¸è¦è¯´ç©ºè¯
4.  æ“ä½œå»ºè®®å¿…é¡»ä¿å®ˆç¨³å¥ï¼Œåˆ†æŒä»“å’Œç©ºä»“ä¸¤ç§æƒ…å†µç»™å‡ºï¼Œç»å¯¹ä¸èƒ½ç»™æ¿€è¿›çš„ä¹°å–å»ºè®®
5.  ç»“å°¾å¿…é¡»åŠ é€šç”¨çš„è‚¡å¸‚é£é™©æç¤º
6.  è¯­è¨€å£è¯­åŒ–ï¼Œé€šä¿—æ˜“æ‡‚ï¼Œé€‚åˆæ™®é€šæ•£æˆ·æŠ•èµ„è€…ï¼Œä¸è¦ç”¨æ™¦æ¶©çš„ä¸“ä¸šæœ¯è¯­

è‚¡ç¥¨å…¨ç»´åº¦ä¿¡æ¯ï¼š
{full_info}
    """

    ai_response = ai_model.generate_content(prompt)
    final_report = f"ğŸ“ˆ {stock_code} å…¨ç»´åº¦æ·±åº¦åˆ†ææŠ¥å‘Š\n\n{ai_response.text}"

except Exception as e:
    final_report = f"âŒ æ·±åº¦åˆ†æå¤±è´¥\nè‚¡ç¥¨ä»£ç ï¼š{stock_code}\né”™è¯¯åŸå› ï¼š{str(e)}\n\næ’æŸ¥å»ºè®®ï¼š\n1. ç¡®è®¤è‚¡ç¥¨ä»£ç æ ¼å¼æ­£ç¡®ï¼ˆæ²ªå¸‚åŠ .SH æ·±å¸‚åŠ .SZï¼‰\n2. æ ¸å¯¹Geminiã€Tavilyå¯†é’¥åç§°æ˜¯å¦æ­£ç¡®ï¼ŒAPIé¢åº¦æ˜¯å¦å……è¶³\n3. ç¡®è®¤è‚¡ç¥¨æ˜¯æ­£å¸¸äº¤æ˜“çš„Aè‚¡ï¼Œæ²¡æœ‰åœç‰Œ/é€€å¸‚"

# ä¿å­˜æŠ¥å‘Šï¼Œå®Œå…¨å…¼å®¹ä½ ä¹‹å‰çš„é’‰é’‰æ¨é€é…ç½®
with open("result.txt", "w", encoding="utf-8") as f:
    f.write(final_report)

print(final_report)
