name: 代码提交自动发钉钉
on:
  push:
    branches:
      - main

jobs:
  send-notify:
    runs-on: ubuntu-latest
    steps:
      - name: 发送提交通知
        env:
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}
        run: |
          timestamp=$(date +%s%3N)
          sign_string=$(printf "%s\n%s" "$timestamp" "$DINGTALK_SECRET")
          sign=$(echo -n "$sign_string" | openssl dgst -sha256 -hmac "$DINGTALK_SECRET" -binary | base64 | tr -d '\n' | sed 's/+/%2B/g; s/\//%2F/g; s/=/%3D/g')
          final_url="${DINGTALK_WEBHOOK}&timestamp=${timestamp}&sign=${sign}"

          curl -X POST "$final_url" \
            -H "Content-Type: application/json" \
            -d '{
              "msgtype": "text",
              "text": {
                "content": "✅ GitHub 代码更新\n仓库：'"${{ github.repository }}"' \n提交人：'"${{ github.actor }}"' \n分支：main"
              }
            }'
