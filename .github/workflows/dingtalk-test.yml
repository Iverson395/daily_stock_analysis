name: é’‰é’‰é€šçŸ¥æµ‹è¯•
on:
  workflow_dispatch:

jobs:
  send-dingtalk-msg:
    runs-on: ubuntu-latest
    steps:
      - name: å‘é€é’‰é’‰æµ‹è¯•æ¶ˆæ¯
        env:
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}
        run: |
          # æ‰“å°å¯†é’¥åŠ è½½çŠ¶æ€ï¼ˆä¸ä¼šæ³„éœ²å®Œæ•´åœ°å€ï¼Œåªçœ‹æœ‰æ²¡æœ‰æˆåŠŸè¯»å–ï¼‰
          echo "WebhookåŠ è½½çŠ¶æ€ï¼š${DINGTALK_WEBHOOK:0:30}......"
          echo "åŠ ç­¾å¯†é’¥åŠ è½½çŠ¶æ€ï¼š${DINGTALK_SECRET:0:10}......"

          # 1. ç”Ÿæˆé’‰é’‰è¦æ±‚çš„æ—¶é—´æˆ³
          timestamp=$(date +%s%3N)
          echo "ç”Ÿæˆçš„æ—¶é—´æˆ³ï¼š$timestamp"

          # 2. è®¡ç®—é’‰é’‰åŠ ç­¾ç­¾å
          sign=$(echo -n "$timestamp\n$DINGTALK_SECRET" | openssl dgst -sha256 -hmac "$DINGTALK_SECRET" -binary | base64 | tr -d '\n' | sed 's/+/%2B/g; s/\//%2F/g; s/=/%3D/g')
          echo "ç”Ÿæˆçš„ç­¾åï¼š$sign"

          # 3. æ‹¼æ¥æœ€ç»ˆæ¨é€åœ°å€
          final_url="${DINGTALK_WEBHOOK}&timestamp=${timestamp}&sign=${sign}"
          echo "æœ€ç»ˆè¯·æ±‚åœ°å€ï¼š${final_url:0:50}......"

          # 4. å‘é€æ¶ˆæ¯ï¼Œæ‰“å°é’‰é’‰å®Œæ•´è¿”å›ç»“æœï¼ˆæ ¸å¿ƒï¼èƒ½çœ‹åˆ°æ‰€æœ‰é”™è¯¯ï¼‰
          echo "===== é’‰é’‰æ¥å£è¿”å›ç»“æœ ====="
          curl -X POST "$final_url" \
            -H "Content-Type: application/json" \
            -d '{
              "msgtype": "text",
              "text": {
                "content": "ğŸ”” é’‰é’‰é€šçŸ¥æµ‹è¯•æˆåŠŸï¼\næ­å–œä½ ï¼Œé…ç½®å®Œå…¨æ­£ç¡®ï¼Œæ¶ˆæ¯å¯ä»¥æ­£å¸¸æ¨é€å•¦~"
              }
            }'
          echo -e "\n===== è¯·æ±‚ç»“æŸ ====="
