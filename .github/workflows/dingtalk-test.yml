name: é’‰é’‰é€šçŸ¥æµ‹è¯•
on:
  workflow_dispatch: # å…è®¸æ‰‹åŠ¨ç‚¹å‡»è§¦å‘ï¼Œæ— éœ€ä¿®æ”¹

jobs:
  send-dingtalk-msg:
    runs-on: ubuntu-latest
    steps:
      - name: å‘é€é’‰é’‰æµ‹è¯•æ¶ˆæ¯
        env:
          # ç›´æ¥å¤ç”¨ä½ ä¹‹å‰å¡«å¥½çš„ä¸¤ä¸ªå¯†é’¥ï¼Œä¸ç”¨æ”¹ä»»ä½•å†…å®¹
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}
        run: |
          # 1. è‡ªåŠ¨ç”Ÿæˆé’‰é’‰è¦æ±‚çš„æ—¶é—´æˆ³ï¼ˆæ¯«ç§’çº§ï¼‰
          timestamp=$(date +%s%3N)
          
          # 2. è‡ªåŠ¨è®¡ç®—é’‰é’‰åŠ ç­¾ç­¾åï¼Œå®Œå…¨ç¬¦åˆé’‰é’‰å®˜æ–¹è§„åˆ™
          sign=$(echo -n "$timestamp\n$DINGTALK_SECRET" | openssl dgst -sha256 -hmac "$DINGTALK_SECRET" -binary | base64 | tr -d '\n' | sed 's/+/%2B/g; s/\//%2F/g; s/=/%3D/g')
          
          # 3. æ‹¼æ¥æœ€ç»ˆçš„é’‰é’‰æ¶ˆæ¯æ¨é€åœ°å€
          final_url="${DINGTALK_WEBHOOK}&timestamp=${timestamp}&sign=${sign}"
          
          # 4. å‘é€æµ‹è¯•æ¶ˆæ¯åˆ°é’‰é’‰ç¾¤
          curl -s -X POST "$final_url" \
            -H "Content-Type: application/json" \
            -d '{
              "msgtype": "text",
              "text": {
                "content": "ğŸ”” é’‰é’‰é€šçŸ¥æµ‹è¯•æˆåŠŸï¼\næ­å–œä½ ï¼Œé…ç½®å®Œå…¨æ­£ç¡®ï¼Œæ¶ˆæ¯å¯ä»¥æ­£å¸¸æ¨é€å•¦~"
              }
            }'
