name: 股票智能分析系统
on:
  # 核心：手动运行（支持直接输股票代码，即时分析）
  workflow_dispatch:
    inputs:
      stock_code:
        description: "【股票代码输入框】单只填：601777.SH；批量填：601777.SH,000001.SZ,hk00700,AAPL"
        required: false
        default: ""
        type: string
  # 定时自动运行：工作日 北京时间9:00(开盘前)、18:00(收盘后) 自动推送
  schedule:
    - cron: "0 1 * * 1-5"  # 北京时间 周一至周五 9:00（UTC时间1:00）
    - cron: "0 10 * * 1-5" # 北京时间 周一至周五 18:00（UTC时间10:00）

jobs:
  daily-stock-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4

      - name: 配置Python环境
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: 安装全量依赖（兼容所有功能）
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy akshare yfinance openai tavily-python requests python-dotenv

      - name: 执行股票分析核心脚本
        env:
          # 1. DeepSeek AI配置
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          # 2. Tavily新闻搜索配置
          TAVILY_API_KEYS: ${{ secrets.TAVILY_API_KEYS }}
          # 3. 钉钉推送配置
          CUSTOM_WEBHOOK_URLS: ${{ secrets.CUSTOM_WEBHOOK_URLS }}
          DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}
          # 4. 股票列表配置
          STOCK_LIST: ${{ secrets.STOCK_LIST }}
          # 5. 可选自定义参数
          NEWS_MAX_AGE_DAYS: ${{ secrets.NEWS_MAX_AGE_DAYS || '3' }}
          BIAS_THRESHOLD: ${{ secrets.BIAS_THRESHOLD || '5.0' }}
        run: python stock_analysis.py "${{ github.event.inputs.stock_code }}"
