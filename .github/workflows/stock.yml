name: 每日股票智能分析
on:
  schedule:
    - cron: '0 10 * * 1-5' # 北京时间工作日18:00自动运行
  workflow_dispatch:
    inputs:
      stock_code:
        description: 手动输入股票代码，多个用逗号分隔，例：002244,09992.HK
        required: false
        type: string
        default: ""
      force_run:
        description: 强制运行（无视交易日）
        required: false
        type: boolean
        default: false
      market_type:
        description: 市场类型
        required: false
        type: choice
        options:
          - cn
          - hk
          - us
          - both
        default: cn
      clear_cache:
        description: 清除依赖缓存
        required: false
        type: boolean
        default: false

env:
  TZ: Asia/Shanghai
  PYTHONPATH: ${{ github.workspace }}

jobs:
  stock_analysis:
    name: 股票分析任务
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4

      - name: 强制设置北京时间时区
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          echo "当前北京时间：$(date '+%Y-%m-%d %H:%M:%S')"

      - name: 设置Python 3.10环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: 清除依赖缓存
        if: ${{ github.event.inputs.clear_cache == 'true' }}
        run: |
          pip cache purge
          rm -rf ~/.cache/pip

      - name: 安装Python依赖（升级最新稳定版）
        run: |
          python -m pip install --upgrade pip
          pip install akshare>=1.16.0 yfinance>=0.2.40 pytz>=2023.3 requests>=2.31.0 openai>=1.0.0 google-generativeai>=0.8.0 --upgrade

      - name: 执行股票分析
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TAVILY_API_KEYS: ${{ secrets.TAVILY_API_KEYS }}
          SERPAPI_API_KEYS: ${{ secrets.SERPAPI_API_KEYS }}
          CUSTOM_WEBHOOK_URLS: ${{ secrets.CUSTOM_WEBHOOK_URLS }}
          DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}
          STOCK_LIST: ${{ secrets.STOCK_LIST }}
          NEWS_MAX_AGE_DAYS: ${{ secrets.NEWS_MAX_AGE_DAYS }}
          BIAS_THRESHOLD: ${{ secrets.BIAS_THRESHOLD }}
          ANALYSIS_DELAY: ${{ secrets.ANALYSIS_DELAY }}
        run: |
          RUN_CMD="python stock_analysis.py"
          if [ -n "${{ github.event.inputs.stock_code }}" ]; then
            RUN_CMD="$RUN_CMD --stock-code ${{ github.event.inputs.stock_code }}"
          fi
          if [ "${{ github.event.inputs.force_run }}" == "true" ]; then
            RUN_CMD="$RUN_CMD --force-run"
          fi
          RUN_CMD="$RUN_CMD --market-type ${{ github.event.inputs.market_type }}"
          echo "执行命令：$RUN_CMD"
          $RUN_CMD
