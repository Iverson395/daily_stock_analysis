name: 股票智能分析系统
on:
  # 核心：手动运行（支持直接输股票代码，即时分析）
  workflow_dispatch:
    inputs:
      stock_code:
        description: "【股票代码输入框】单只填：601777.SH；批量填：601777.SH,000001.SZ,hk00700,AAPL"
        required: false
        default: ""
        type: string
  # 可选：定时自动运行（工作日每天18点自动分析STOCK_LIST里的股票，不需要直接删掉这段）
  schedule:
    - cron: "0 10 * * 1-5"

jobs:
  daily-stock-analysis:
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4

      - name: 配置Python环境
        uses: actions/setup-python@v5
        with:
          python-version: "3.10"
          cache: "pip"

      - name: 安装全量依赖（兼容开源系统所有功能）
        run: |
          python -m pip install --upgrade pip
          pip install pandas numpy akshare yfinance openai tavily-python requests python-dotenv

      - name: 执行股票分析核心脚本
        env:
          # 1. 你已配置的DeepSeek（OpenAI兼容格式，必填）
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          # 2. 你已配置的钉钉推送（必填）
          CUSTOM_WEBHOOK_URLS: ${{ secrets.CUSTOM_WEBHOOK_URLS }}
          # 3. 你已配置的Tavily新闻搜索（必填）
          TAVILY_API_KEYS: ${{ secrets.TAVILY_API_KEYS }}
          # 4. 批量分析股票列表（必填，手动输代码时优先用手动输入的）
          STOCK_LIST: ${{ secrets.STOCK_LIST }}
          # 5. 可选自定义配置（按需添加，和开源项目完全兼容）
          NEWS_MAX_AGE_DAYS: ${{ secrets.NEWS_MAX_AGE_DAYS || '3' }}
          BIAS_THRESHOLD: ${{ secrets.BIAS_THRESHOLD || '5.0' }}
        # 核心：把手动输入的股票代码传给py脚本，实现输代码就出分析
        run: python stock_analysis.py "${{ github.event.inputs.stock_code }}"
