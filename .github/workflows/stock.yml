name: 股票深度分析钉钉推送
on:
  # 手动输入股票代码触发（你日常用的模式）
  workflow_dispatch:
    inputs:
      stock_code:
        description: "输入股票代码 沪市加.SH 深市加.SZ 例：600519.SH"
        required: true
        default: "600519.SH"
  # 可选：交易日收盘后自动分析你的自选股，需要的话取消下面两行的注释即可
  # schedule:
  #   - cron: "0 8 * * 1-5" # 北京时间周一到周五16:00（A股收盘后）

jobs:
  analysis-and-send:
    runs-on: ubuntu-latest
    steps:
      - name: 拉取仓库代码
        uses: actions/checkout@v4

      - name: 设置Python环境
        uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - name: 安装所有依赖库（自动安装，不用你管）
        run: |
          pip install akshare
          pip install google-generativeai
          pip install tavily-python

      - name: 运行股票深度分析（自动加载你已有的3个密钥）
        env:
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
        run: python stock_analysis.py ${{ inputs.stock_code }}

      - name: 推送分析报告到钉钉（复用你已有的配置）
        env:
          DINGTALK_WEBHOOK: ${{ secrets.DINGTALK_WEBHOOK }}
          DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}
        run: |
          # 读取生成的深度分析报告
          report_content=$(cat result.txt)
          # 钉钉签名生成（和你之前能用的逻辑完全一致，不会报错）
          timestamp=$(date +%s%3N)
          sign_string=$(printf "%s\n%s" "$timestamp" "$DINGTALK_SECRET")
          sign=$(echo -n "$sign_string" | openssl dgst -sha256 -hmac "$DINGTALK_SECRET" -binary | base64 | tr -d '\n' | sed 's/+/%2B/g; s/\//%2F/g; s/=/%3D/g')
          final_url="${DINGTALK_WEBHOOK}&timestamp=${timestamp}&sign=${sign}"

          # 推送到钉钉群
          curl -X POST "$final_url" \
            -H "Content-Type: application/json" \
            -d '{
              "msgtype": "text",
              "text": {
                "content": "'"$report_content"'"
              }
            }'
