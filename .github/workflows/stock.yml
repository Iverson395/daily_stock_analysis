name: 每日股票智能分析
on:
  # 定时任务：北京时间每个工作日18:00自动运行（和原项目一致）
  schedule:
    - cron: '0 10 * * 1-5'
  # 手动触发（支持手动输入股票代码）
  workflow_dispatch:
    inputs:
      stock_code:
        description: 手动输入股票代码，多个用逗号分隔，例：002244,600519（不填用STOCK_LIST固定配置）
        required: false
        type: string
        default: ""
      force_run:
        description: 强制运行（无视交易日，节假日也能跑）
        required: false
        type: boolean
        default: false
      clear_cache:
        description: 清除依赖缓存（运行失败时勾选）
        required: false
        type: boolean
        default: false

# 全局锁定北京时间
env:
  TZ: Asia/Shanghai
  PYTHONPATH: ${{ github.workspace }}

jobs:
  stock_analysis:
    name: 股票分析任务
    runs-on: ubuntu-latest
    steps:
      - name: 检出仓库代码
        uses: actions/checkout@v4

      - name: 强制设置北京时间时区
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          echo "当前北京时间：$(date '+%Y-%m-%d %H:%M:%S')"

      - name: 设置Python 3.10环境
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      - name: 清除依赖缓存
        if: ${{ github.event.inputs.clear_cache == 'true' }}
        run: |
          pip cache purge
          rm -rf ~/.cache/pip

      - name: 安装Python依赖
        run: |
          python -m pip install --upgrade pip
          pip install akshare>=1.13.0 yfinance>=0.2.40 pytz>=2023.3 requests>=2.31.0 openai>=1.0.0 google-generativeai>=0.8.0

      - name: 执行股票分析
        env:
          # 你的AI模型配置
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          # 你的新闻搜索配置
          TAVILY_API_KEYS: ${{ secrets.TAVILY_API_KEYS }}
          SERPAPI_API_KEYS: ${{ secrets.SERPAPI_API_KEYS }}
          # 你的钉钉推送配置（适配加签）
          DINGTALK_WEBHOOK_URL: ${{ secrets.CUSTOM_WEBHOOK_URLS }}
          DINGTALK_SECRET: ${{ secrets.DINGTALK_SECRET }}
          # 固定自选股配置
          STOCK_LIST: ${{ secrets.STOCK_LIST }}
          # 可选配置（空值也不会报错）
          NEWS_MAX_AGE_DAYS: ${{ secrets.NEWS_MAX_AGE_DAYS }}
          BIAS_THRESHOLD: ${{ secrets.BIAS_THRESHOLD }}
          ANALYSIS_DELAY: ${{ secrets.ANALYSIS_DELAY }}
          REPORT_SUMMARY_ONLY: ${{ secrets.REPORT_SUMMARY_ONLY }}
          SINGLE_STOCK_NOTIFY: ${{ secrets.SINGLE_STOCK_NOTIFY }}
        run: |
          RUN_CMD="python stock_analysis.py"
          if [ -n "${{ github.event.inputs.stock_code }}" ]; then
            RUN_CMD="$RUN_CMD --stock-code ${{ github.event.inputs.stock_code }}"
          fi
          if [ "${{ github.event.inputs.force_run }}" == "true" ]; then
            RUN_CMD="$RUN_CMD --force-run"
          fi
          echo "执行命令：$RUN_CMD"
          $RUN_CMD
