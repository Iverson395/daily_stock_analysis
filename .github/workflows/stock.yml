name: è‚¡ç¥¨æ™ºèƒ½åˆ†æç³»ç»Ÿï¼ˆæ‰‹åŠ¨è¾“å…¥å®šåˆ¶ç‰ˆï¼‰
on:
  # å®šæ—¶ä»»åŠ¡ï¼šåŒ—äº¬æ—¶é—´æ¯ä¸ªå·¥ä½œæ—¥18:00è‡ªåŠ¨è¿è¡Œï¼ˆå¯¹åº”UTCæ—¶é—´10:00ï¼Œå¯¹é½åŸé¡¹ç›®ï¼‰
  schedule:
    - cron: '0 10 * * 1-5'
  # æ‰‹åŠ¨è§¦å‘ï¼ˆæ ¸å¿ƒï¼šæ”¯æŒæ‰‹åŠ¨è¾“å…¥è‚¡ç¥¨ä»£ç ï¼Œæ— éœ€ä¿®æ”¹é…ç½®ï¼‰
  workflow_dispatch:
    inputs:
      stock_code:
        description: ğŸ‘‰ æ‰‹åŠ¨è¾“å…¥è‚¡ç¥¨ä»£ç ï¼Œå¤šä¸ªç”¨é€—å·åˆ†éš”ï¼Œä¾‹ï¼š002244,600519,AAPL,hk00700ï¼ˆä¸å¡«åˆ™ä½¿ç”¨STOCK_LISTå›ºå®šé…ç½®ï¼‰
        required: false
        type: string
        default: ""
      force_run:
        description: å¼ºåˆ¶è¿è¡Œï¼ˆæ— è§†äº¤æ˜“æ—¥åˆ¤æ–­ï¼ŒèŠ‚å‡æ—¥/å‘¨æœ«ä¹Ÿèƒ½è¿è¡Œï¼‰
        required: false
        type: boolean
        default: false
      market_type:
        description: å¸‚åœºç±»å‹ï¼šcn(Aè‚¡)/us(ç¾è‚¡)/both(ä¸¤è€…)
        required: false
        type: choice
        options:
          - cn
          - us
          - both
        default: cn
      clear_cache:
        description: æ¸…é™¤ä¾èµ–ç¼“å­˜ï¼ˆè¿è¡Œå¤±è´¥æ—¶å‹¾é€‰ï¼‰
        required: false
        type: boolean
        default: false

# å…¨å±€ç¯å¢ƒå˜é‡ï¼ˆé”å®šåŒ—äº¬æ—¶é—´ï¼Œå½»åº•è§£å†³æ—¶å·®bugï¼‰
env:
  TZ: Asia/Shanghai
  PYTHONPATH: ${{ github.workspace }}

jobs:
  stock_analysis_job:
    name: è‚¡ç¥¨åˆ†æä»»åŠ¡
    runs-on: ubuntu-latest
    steps:
      # æ­¥éª¤1ï¼šæ£€å‡ºä»“åº“ä»£ç 
      - name: æ£€å‡ºä»“åº“ä»£ç 
        uses: actions/checkout@v4

      # æ­¥éª¤2ï¼šå¼ºåˆ¶è®¾ç½®åŒ—äº¬æ—¶é—´æ—¶åŒºï¼ˆå½»åº•è§£å†³UTCæ—¶å·®å¯¼è‡´çš„äº¤æ˜“æ—¥è¯¯åˆ¤ï¼‰
      - name: é”å®šåŒ—äº¬æ—¶é—´æ—¶åŒº
        run: |
          sudo timedatectl set-timezone Asia/Shanghai
          echo "===== ç³»ç»Ÿæ—¶é—´æ ¡éªŒ ====="
          echo "å½“å‰åŒ—äº¬æ—¶é—´ï¼š$(date '+%Y-%m-%d %H:%M:%S')"
          echo "å½“å‰ç³»ç»Ÿæ—¥æœŸï¼š$(date '+%Y-%m-%d')"
          echo "=========================="

      # æ­¥éª¤3ï¼šè®¾ç½®Pythonç¯å¢ƒï¼ˆå¯¹é½åŸé¡¹ç›®python3.10+è¦æ±‚ï¼‰
      - name: è®¾ç½®Python 3.10ç¯å¢ƒ
        uses: actions/setup-python@v5
        with:
          python-version: '3.10'
          cache: 'pip'

      # æ­¥éª¤4ï¼šæ¸…é™¤ç¼“å­˜ï¼ˆè¿è¡Œå¤±è´¥æ—¶ä½¿ç”¨ï¼‰
      - name: æ¸…é™¤ä¾èµ–ç¼“å­˜
        if: ${{ github.event.inputs.clear_cache == 'true' }}
        run: |
          pip cache purge
          rm -rf ~/.cache/pip

      # æ­¥éª¤5ï¼šå®‰è£…é¡¹ç›®ä¾èµ–ï¼ˆå…¨é‡å…¼å®¹åŸé¡¹ç›®ï¼‰
      - name: å®‰è£…Pythonä¾èµ–
        run: |
          python -m pip install --upgrade pip
          pip install akshare>=1.13.0 yfinance>=0.2.40 pytz>=2023.3 requests>=2.31.0 openai>=1.0.0 google-generativeai>=0.8.0 anthropic>=0.30.0 python-dotenv>=1.0.0

      # æ­¥éª¤6ï¼šæ‰§è¡Œè‚¡ç¥¨åˆ†ææ ¸å¿ƒè„šæœ¬ï¼ˆæ ¸å¿ƒï¼šæŠŠæ‰‹åŠ¨è¾“å…¥çš„è‚¡ç¥¨ä»£ç ä¼ ç»™è„šæœ¬ï¼‰
      - name: æ‰§è¡Œè‚¡ç¥¨åˆ†æ
        env:
          # ---------------------- ä½ å·²é…ç½®çš„DeepSeekï¼ˆOpenAIå…¼å®¹ï¼‰----------------------
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
          OPENAI_BASE_URL: ${{ secrets.OPENAI_BASE_URL }}
          OPENAI_MODEL: ${{ secrets.OPENAI_MODEL }}
          # ---------------------- ä½ å·²é…ç½®çš„Tavilyæ–°é—»æœç´¢ ----------------------
          TAVILY_API_KEY: ${{ secrets.TAVILY_API_KEY }}
          TAVILY_API_KEYS: ${{ secrets.TAVILY_API_KEYS }}
          # ---------------------- ä½ å·²é…ç½®çš„é’‰é’‰æ¨é€ ----------------------
          DINGTALK_WEBHOOK_URL: ${{ secrets.DINGTALK_WEBHOOK_URL }}
          CUSTOM_WEBHOOK_URLS: ${{ secrets.CUSTOM_WEBHOOK_URLS }}
          # ---------------------- å…¼å®¹åŸé¡¹ç›®å…¨é‡Secretsé…ç½®ï¼ˆæ— éœ€ä¿®æ”¹ï¼‰----------------------
          GEMINI_API_KEY: ${{ secrets.GEMINI_API_KEY }}
          ANTHROPIC_API_KEY: ${{ secrets.ANTHROPIC_API_KEY }}
          ANTHROPIC_MODEL: ${{ secrets.ANTHROPIC_MODEL }}
          SERPAPI_API_KEY: ${{ secrets.SERPAPI_API_KEY }}
          SERPAPI_API_KEYS: ${{ secrets.SERPAPI_API_KEYS }}
          BOCHA_API_KEYS: ${{ secrets.BOCHA_API_KEYS }}
          BRAVE_API_KEYS: ${{ secrets.BRAVE_API_KEYS }}
          WECHAT_WEBHOOK_URL: ${{ secrets.WECHAT_WEBHOOK_URL }}
          FEISHU_WEBHOOK_URL: ${{ secrets.FEISHU_WEBHOOK_URL }}
          TELEGRAM_BOT_TOKEN: ${{ secrets.TELEGRAM_BOT_TOKEN }}
          TELEGRAM_CHAT_ID: ${{ secrets.TELEGRAM_CHAT_ID }}
          EMAIL_SENDER: ${{ secrets.EMAIL_SENDER }}
          EMAIL_PASSWORD: ${{ secrets.EMAIL_PASSWORD }}
          EMAIL_RECEIVERS: ${{ secrets.EMAIL_RECEIVERS }}
          # ---------------------- åŸé¡¹ç›®è‡ªå®šä¹‰é…ç½®ï¼ˆå¯é€‰ï¼‰----------------------
          STOCK_LIST: ${{ secrets.STOCK_LIST }}
          NEWS_MAX_AGE_DAYS: ${{ secrets.NEWS_MAX_AGE_DAYS }}
          BIAS_THRESHOLD: ${{ secrets.BIAS_THRESHOLD }}
          REPORT_TYPE: ${{ secrets.REPORT_TYPE }}
          REPORT_SUMMARY_ONLY: ${{ secrets.REPORT_SUMMARY_ONLY }}
          SINGLE_STOCK_NOTIFY: ${{ secrets.SINGLE_STOCK_NOTIFY }}
          ANALYSIS_DELAY: ${{ secrets.ANALYSIS_DELAY }}
        run: |
          # æ„å»ºè¿è¡Œå‘½ä»¤
          RUN_CMD="python stock_analysis.py"
          # æ·»åŠ æ‰‹åŠ¨è¾“å…¥çš„è‚¡ç¥¨ä»£ç 
          if [ -n "${{ github.event.inputs.stock_code }}" ]; then
            RUN_CMD="$RUN_CMD --stock-code ${{ github.event.inputs.stock_code }}"
          fi
          # æ·»åŠ å¼ºåˆ¶è¿è¡Œå‚æ•°
          if [ "${{ github.event.inputs.force_run }}" == "true" ]; then
            RUN_CMD="$RUN_CMD --force-run"
          fi
          # æ·»åŠ å¸‚åœºç±»å‹å‚æ•°
          RUN_CMD="$RUN_CMD --market-type ${{ github.event.inputs.market_type }}"
          # æ‰§è¡Œå‘½ä»¤
          echo "æ‰§è¡Œå‘½ä»¤ï¼š$RUN_CMD"
          $RUN_CMD
